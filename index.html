<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Access</title>
</head>
<body>
    <video id="myVideo" autoplay></video>
    <button onclick="stopRecording()">Stop Recording</button>
    <script>
        let mediaRecorder;
        let recordedChunks = [];

        async function initializeCameraStream() {
            try {
                const cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { min: 320, ideal: 320 },
                        height: { min: 240, ideal: 240 },
                        facingMode: { ideal: "user" }
                    },
                    audio: false
                });

                mediaRecorder = new MediaRecorder(cameraStream);
                mediaRecorder.ondataavailable = handleDataAvailable;
                mediaRecorder.onstop = handleStop;

                mediaRecorder.onstart = () => {
                    console.log('MediaRecorder started');
                };

                mediaRecorder.onpause = () => {
                    console.log('MediaRecorder paused');
                };

                mediaRecorder.onresume = () => {
                    console.log('MediaRecorder resumed');
                };

                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event.error);
                };

                document.getElementById("myVideo").srcObject = cameraStream;
                mediaRecorder.start(1000); // Request data every second
                console.log("Created new mediaRecorder:", mediaRecorder);
            } catch (error) {
                console.error('Error accessing camera:', error);
            }
        }

        function handleDataAvailable(event) {
            console.log("Attempting to handle data with size: " + event.data.size);
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
                console.log('Data available:', event.data);
            }
        }

        function handleStop() {
            const recordedBlob = new Blob(recordedChunks, { type: 'video/webm' });
            const videoUrl = URL.createObjectURL(recordedBlob);

            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = videoUrl;
            console.log("Downloading this video... " + videoUrl);
            var subjID = 'defaultID'; // Replace this with actual participantID if available
            a.download = 'recorded-video' + subjID + '.webm';
            document.body.appendChild(a);
            a.click();

            window.URL.revokeObjectURL(videoUrl);
            recordedChunks = [];
            console.log("STOP HANDLED!");

            uploadVideo(recordedBlob);
        }

        function stopRecording() {
            mediaRecorder.stop();
        }

        async function uploadVideo(blob) {
            const reader = new FileReader();
            reader.onloadend = function() {
                const arrayBuffer = reader.result;
                const binaryData = new Uint8Array(arrayBuffer);

                fetch('/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/octet-stream'
                    },
                    body: binaryData
                }).then(response => response.json())
                  .then(data => console.log('Video uploaded successfully:', data))
                  .catch(err => console.error('Error uploading video:', err));
            };
            reader.readAsArrayBuffer(blob);
        }

        initializeCameraStream();
    </script>
</body>
</html>
